#summary Installation et utilisation pas à pas du script save-logged-user-in-database.pl

= Introduction =

Cette page explique l'installation et l'utilisation pas à pas du script « save-logged-user-in-database.pl ».  

Le script « save-logged-user-in-database.pl » lit la liste des pseudos connectées sur le chat Coco.fr plusieurs fois par minutes, puis enregistre toutes les connexions et déconnexions des pseudos dans une base de données MySQL. Le script est prévu pour fonctionner 24 heures sur 24 et sept jours sur sept et nécessite de souscrire un abonnement Premium sur Coco.fr. [cocoRegistration Lire la documentation sur comment souscrire à un abonnement Premium sur le site Coco.fr]

Cette documentation se base sur le système d'exploitation Ubuntu 12.10 Desktop, donc pour installer ce script un système d'exploitation Ubuntu 12.10 Desktop est requis. 

Toutes les manipulations se font à l'aide de la ligne de commande, donc une connaissance minimum de l'utilisation de la ligne de commande dans un terminal est nécessaire.


= Installation =

== Installer les dépendances ==

Lancer le logiciel Terminal pour pouvoir utiliser les commandes en ligne de commande.

Pour lancer le Terminal, cliquer tout en haut à droite de l'écran sur le logo Ubuntu. Ensuite taper le mot « terminal » dans la zone de recherche :

http://cocobot.googlecode.com/svn/wiki/terminal.png


Taper la commande suivante pour installer certains logiciels : 
{{{
sudo apt-get install subversion libconfig-general-perl libwww-perl libdbd-sqlite3-perl mysql-server
}}}

À l'installation de MySQL, le programme d'installation demande un mot de passe pour l'utilisateur « root ». Dans cet exemple le mot de passe « toto » a été donné. 

== Récupérer le code source ==

Taper la commande suivante sur dans Terminal pour récupérer le code source :
{{{
svn checkout http://cocobot.googlecode.com/svn/trunk/ cocobot-read-only
}}}

== Créer la base de données MySQL ==

La base de données MySQL utilisée dans l'exemple est la base de données « test ». Cette base de données est créé par défaut à l'installation de MySQL. L'utilisateur de la base de données aura le même nom, c'est à dire « test » et le mot de passe sera « Gim9p6gW ». Ces trois paramètres peuvent être changés dans le fichier de configuration.

Taper les quatre commandes suivants dans Terminal pour créer l'utilisateur MySQL « test » :
{{{
mysql -u root -ptoto 
GRANT ALL PRIVILEGES ON `test`.* TO test@"localhost" IDENTIFIED BY 'Gim9p6gW';
FLUSH PRIVILEGES;
exit
}}}

http://cocobot.googlecode.com/svn/wiki/mysql-add-user.png

Pour utiliser une autre base de données MySQL, un autre utilisateur ou un autre mot de passe, le fichier « database.conf » doit-être modifié en conséquence :
{{{
cat ~/cocobot-read-only/conf/database.conf 
<conf>
  #database-class     = SQLite
  database-class     = MySQL 
  sqlite-filename    = logged-users.db
  ISO-3166-1-alpha-2 = (FR|GF|GP|MQ|NC|PF|RE)\-
  code-regex         = [A-Za-z0-9]{3}
  dbi-datasource    = dbi:mysql:database=test:host=localhost
  dbi-username      = test
  dbi-password      = Gim9p6gW
  dbi-timeout       = 30
</conf>
}}}

=== Initialiser la base de données MySQL ===

Les tables de la base de données MySQL doit-être créés et certaines tables peuplées avec des données :
{{{
cd ~/cocobot-read-only/tools/
./initializes-database.pl
}}}

Le script peut prendre quelques secondes ou minutes avant de rendre la main.


== Configurer le script dans la table du programme cron ==

L'objectif est de lancer le script « save-logged-user-in-database.pl » tous les minutes. Pour cela nous allons configurer le programme [http://fr.wikipedia.org/wiki/Cron cron] pour qu'il exécute le script « save-logged-user-in-database.pl » toutes les minutes.

Tout d'abord vous devez récupérer les valeurs de « myavatar » et « mypass » d'un compte ayant un abonnement payant Premium. Lire la documentation sur [cocoRegistration  comment souscrire à un abonnement Premium sur le site Coco.fr et récupérer les valeurs de « myavatar » et « mypass »].

Dans notre exemple :
 * « myavatar » correspond à la valeur « 816356817 »
 * « mypass » correspond à la valeur « XYZPAHPFLFRIEBWDNDZD ».

Nous allons lancer [http://fr.wikipedia.org/wiki/Crontab le programme crontab] qui permet d'éditer des tables de configuration du programme _cron_. 

Taper la commande suivante dans un terminal pour éditer la table de configuration du programme _cron_ :
{{{
crontab -e
}}}

À la première utilisation, le programme _crontab_ vous demande quel éditeur texte vous allez utiliser. Sélectionner le choix conseillé en tapant sur la touche _2_ du clavier pour choisir l'éditeur [http://fr.wikipedia.org/wiki/GNU_nano nano]] :

http://cocobot.googlecode.com/svn/wiki/save-logged-user-in-database/select-editor.png

Une fois l'éditeur _nano_ lancé, presser sur la touche directionnelle bas pour se rendre tout à la fin du texte et insérer la ligne suivante :

{{{
*/1 * * * * cd ~/cocobot-read-only/scripts/ && ./save-logged-user-in-database.pl -s M -a 816356817 -p XYZPAHPFLFRIEBWDNDZD -v -d -D -x 38 -w
}}}

Ensuite taper les touches _Ctrl + X_ pour quitter l'éditeur _nano_. Le message «  Sauver l'espace modifié (RÉPONDRE « Non » EFFACERA LES CHANGEMENTS) ? » s'affichera alors. Presser la touche _O_ puis ensuite la touche _entrée_ pour sauvegarder :
                                                                                                                   
http://cocobot.googlecode.com/svn/wiki/save-logged-user-in-database/nano-sauver-l-espace-modifie.png

Pour vérifier si la table de configuration du programme _cron_ est bien paramétrée taper la commande :
{{{
crontab -l
}}}

Si la table de configuration du programme _cron_ est bien paramétrée vous devriez voir ce résultat :

http://cocobot.googlecode.com/svn/wiki/save-logged-user-in-database/crontab-l.png

Visionner le fichier de log du script pour vérifier que le script « save-logged-user-in-database.pl » est bien lancé toutes les minutes. Le fichier de log est composé avec la date du jour. Par exemple cette documentation a été écrite le 7 décembre 2012, donc le fichier de log se nomme « 2012-12-07_save-logged-user-in-database.pl.log ». Utiliser la commande suivante pour le visionner :

{{{
tail -f ~/cocobot-read-only/var/logs/2012-12-07_save-logged-user-in-database.pl.log
}}}


Si vous voyez un résultat semblable à cette capture d'écran, alors le script « save-logged-user-in-database.pl » fonctionne :

http://cocobot.googlecode.com/svn/wiki/save-logged-user-in-database/tail-f-log.png


Taper CTRL + C pour stopper la [http://fr.wikipedia.org/wiki/Tail_%28Unix%29 commande tail]. Et maintenant vous pouvez utiliser la commande « db-search.pl » pour consulter la base de données :
{{{
cd ~/cocobot-read-only/scripts
./db-search.pl -O -s 2,7
}}}





